function l(n,e=!1){const t=document.createElement("div");t.className="toast",t.textContent=n,e&&t.classList.add("error"),document.body.appendChild(t),setTimeout(()=>t.remove(),2500)}async function pe(n){typeof n.filters=="object"&&(n.filters=JSON.stringify(n.filters));const e=new URLSearchParams(n).toString(),t=await fetch(`/api/search_v4.php?${e}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}async function L(){ue();try{const{products:n,totalProducts:e}=await pe({page:window.currentPage,itemsPerPage:window.itemsPerPage,sortColumn:window.sortColumn,sortDirection:window.sortDirection,filters:window.appliedFilters});window.productsData=n,window.totalProducts=e,n.length===0&&l("Ничего не найдено",!1),window.renderProductsTable();const t=window.productsData.map(a=>a.product_id);window.loadAvailability(t)}catch{l("Ошибка при загрузке продуктов",!0)}finally{he()}}function ue(){const n=document.createElement("div");n.className="loading-indicator",n.textContent="Загрузка...",document.body.appendChild(n)}function he(){const n=document.querySelector(".loading-indicator");n&&n.remove()}function z(n,e){window.appliedFilters[n]===e?(delete window.appliedFilters[n],sessionStorage.removeItem(n)):(window.appliedFilters[n]=e,sessionStorage.setItem(n,e)),L()}async function H(n){var i;const e=((i=document.getElementById("citySelect"))==null?void 0:i.value)||"1";if(!Array.isArray(n)||!n.length){console.warn("loadAvailability: нет товаров для проверки");return}const t=100,a=[];for(let s=0;s<n.length;s+=t)a.push(n.slice(s,s+t));try{const s=a.map(c=>{const d=new URLSearchParams({city_id:e,product_ids:c.join(",")}).toString();return fetch(`/get_availability.php?${d}`).then(p=>{if(!p.ok)throw new Error(`HTTP ${p.status}`);return p.json()}).catch(p=>(console.error("Ошибка загрузки батча:",p),{}))}),r=await Promise.all(s),o=Object.assign({},...r);n.forEach(c=>{const d=document.querySelector(`tr[data-product-id="${c}"]`);if(!d)return;const p=d.querySelector(".availability-cell, .col-availability span"),f=d.querySelector(".delivery-date-cell, .col-delivery-date span");if(o[c]){if(p){const h=o[c].quantity??0;p.textContent=h>0?`${h} шт.`:"Нет",p.classList.toggle("in-stock",h>0),p.classList.toggle("out-of-stock",h===0)}if(f){const h=o[c].delivery_date;f.textContent=h||"—"}}else p&&(p.textContent="—"),f&&(f.textContent="—")})}catch(s){console.error("Критическая ошибка при загрузке наличия:",s),l("Ошибка при загрузке наличия товаров",!0),n.forEach(r=>{const o=document.querySelector(`tr[data-product-id="${r}"]`);if(o){const c=o.querySelector(".availability-cell, .col-availability span"),d=o.querySelector(".delivery-date-cell, .col-delivery-date span");c&&(c.textContent="Ошибка"),d&&(d.textContent="Ошибка")}})}}function k(n){if(!n){l("Нечего копировать",!0);return}if(!navigator.clipboard){l("Clipboard API не поддерживается",!0);return}navigator.clipboard.writeText(n).then(()=>l(`Скопировано: ${n}`)).catch(()=>l("Не удалось скопировать",!0))}function me(){const n=document.querySelector(".product-table tbody");if(n){if(n.innerHTML="",window.productsData.forEach(e=>{const t=document.createElement("tr");t.setAttribute("data-product-id",e.product_id);const a=document.createElement("td"),i=document.createElement("input");i.type="checkbox",i.classList.add("product-checkbox"),a.appendChild(i),t.appendChild(a);const s=document.createElement("td");s.classList.add("col-code");const r=document.createElement("div");r.className="item-code";const o=document.createElement("span");o.textContent=e.external_id||"",r.appendChild(o);const c=document.createElement("a");c.className="copy-icon js-copy-to-clipboard",c.href="#",c.setAttribute("data-text-to-copy",e.external_id||""),c.innerHTML='<i class="far fa-clone"></i>',c.addEventListener("click",C=>{C.preventDefault(),k(c.getAttribute("data-text-to-copy"))}),r.appendChild(c),s.appendChild(r),t.appendChild(s);const d=document.createElement("td");let p=[];typeof e.image_urls=="string"&&e.image_urls.trim()&&(p=e.image_urls.split(",").map(C=>C.trim()));const f=p[0]||"/images/placeholder.jpg",h=document.createElement("div");h.className="image-container",h.style.position="relative";const m=document.createElement("img");m.src=f,m.alt=e.name||"",m.style.width="50px",m.style.cursor="pointer",m.style.transition="opacity 0.3s ease";const u=document.createElement("img");u.className="zoom-image",u.src=f,u.alt=e.name||"",u.style.width="350px",u.style.position="absolute",u.style.top="0",u.style.left="60px",u.style.opacity="0",u.style.transition="opacity 0.3s ease",u.style.pointerEvents="none",m.addEventListener("mouseenter",()=>{u.style.opacity="1",u.style.pointerEvents="auto"}),m.addEventListener("mouseleave",()=>{u.style.opacity="0",u.style.pointerEvents="none"}),h.appendChild(m),h.appendChild(u);const A=document.createElement("a");A.href=`/shop/product?id=${e.external_id}`,A.appendChild(h),d.appendChild(A),t.appendChild(d);const D=document.createElement("td");D.className="name-cell";const x=document.createElement("a");x.href=`/shop/product?id=${e.external_id}`,x.style.color="inherit",x.style.textDecoration="none";const I=document.createElement("div");I.className="item-code";const U=document.createElement("span");U.textContent=e.name||"",I.appendChild(U);const w=document.createElement("a");w.className="copy-icon js-copy-to-clipboard",w.href="#",w.setAttribute("data-text-to-copy",e.name||""),w.innerHTML='<i class="far fa-clone"></i>',w.addEventListener("click",C=>{C.preventDefault(),k(w.getAttribute("data-text-to-copy"))}),I.appendChild(w),x.appendChild(I),D.appendChild(x),t.appendChild(D);const Q=document.createElement("td"),P=document.createElement("div");P.className="item-code";const W=document.createElement("span");W.textContent=e.sku||"",P.appendChild(W);const g=document.createElement("a");g.className="copy-icon js-copy-to-clipboard",g.href="#",g.setAttribute("data-text-to-copy",e.sku||""),g.innerHTML='<i class="far fa-clone"></i>',g.addEventListener("click",C=>{C.preventDefault(),k(g.getAttribute("data-text-to-copy"))}),P.appendChild(g),Q.appendChild(P),t.appendChild(Q);const G=document.createElement("td"),_=document.createElement("div"),y=document.createElement("span");y.className="brand-name",y.textContent=e.brand_name||"",y.style.cursor="pointer",y.addEventListener("click",()=>z("brand_name",e.brand_name));const b=document.createElement("span");b.className="series-name",b.textContent=e.series_name||"",b.style.cursor="pointer",b.addEventListener("click",()=>z("series_name",e.series_name)),y.textContent&&b.textContent&&(y.textContent+=" / "),_.appendChild(y),_.appendChild(b),G.appendChild(_),t.appendChild(G);const J=document.createElement("td"),V=document.createElement("span");V.textContent=e.status||"Активен",J.appendChild(V),t.appendChild(J);const F=document.createElement("td"),Y=document.createElement("span");Y.textContent=e.min_sale||"";const X=document.createElement("span");X.textContent=e.unit?` / ${e.unit}`:"",F.appendChild(Y),F.appendChild(X),t.appendChild(F);const N=document.createElement("td");N.classList.add("col-availability");const Z=document.createElement("span");Z.textContent="…",N.appendChild(Z),t.appendChild(N);const q=document.createElement("td");q.classList.add("col-delivery-date");const ee=document.createElement("span");ee.textContent="…",q.appendChild(ee),t.appendChild(q);const j=document.createElement("td"),M=document.createElement("span");M.textContent=e.base_price?`${e.base_price.toFixed(2)} руб.`:"Нет цены",j.appendChild(M),j.setAttribute("data-fulltext",M.textContent),t.appendChild(j);const O=document.createElement("td"),R=document.createElement("span");R.textContent=e.retail_price?`${e.retail_price.toFixed(2)} руб.`:"Нет розничной цены",O.appendChild(R),O.setAttribute("data-fulltext",R.textContent),t.appendChild(O);const B=document.createElement("td"),v=document.createElement("input");v.className="form-control quantity-input",v.type="number",v.value=1,v.min=1;const T=document.createElement("button");T.className="add-to-cart-btn",T.innerHTML='<i class="fas fa-shopping-cart"></i>',T.dataset.productId=e.product_id,B.appendChild(v),B.appendChild(T),t.appendChild(B);const te=document.createElement("td"),ne=document.createElement("span");ne.textContent="Доп. информация",te.appendChild(ne),t.appendChild(te);const ae=document.createElement("td"),oe=document.createElement("span");oe.textContent=e.orders_count||"0",ae.appendChild(oe),t.appendChild(ae),n.appendChild(t)}),typeof window.updatePaginationDisplay=="function"&&window.updatePaginationDisplay(),typeof window.renderAppliedFilters=="function"&&window.renderAppliedFilters(),typeof window.highlightFilteredWords=="function"&&window.highlightFilteredWords(),window.productsData.length){const e=window.productsData.map(t=>t.product_id);H(e)}try{const e=$("#productTable");e.length>0&&$.fn.colResizable&&(e.colResizable("destroy"),e.colResizable({liveDrag:!0,minWidth:30,hoverCursor:"col-resize"}))}catch(e){console.error("Ошибка инициализации colResizable:",e)}}}function fe(n){window.itemsPerPage=parseInt(n.target.value,10)||20,sessionStorage.setItem("itemsPerPage",window.itemsPerPage),window.currentPage=1,L()}function se(n){let e=parseInt(n.target.value,10)||1;const t=Math.ceil(window.totalProducts/window.itemsPerPage);e=Math.max(1,Math.min(e,t)),window.currentPage=e,L()}function we(n){n.key==="Enter"&&se(n)}function K(n){window.currentPage=n,L()}async function E(){try{const n=await fetch("/cart/json");if(!n.ok)throw new Error("Ошибка загрузки корзины");const e=await n.json();window.cart=e.cart||{}}catch{l("Ошибка при загрузке корзины",!0)}}async function ce(n,e){try{const t=new FormData;t.append("product_id",n),t.append("quantity",e),t.append("csrf_token",window.CSRF_TOKEN||"");const a=await fetch("/cart/add",{method:"POST",body:t});if(!a.ok)throw new Error("Ошибка добавления в корзину");const i=await a.json();i.success?(l("Товар добавлен в корзину"),await E()):l(i.message||"Ошибка при добавлении в корзину",!0)}catch{l("Ошибка при добавлении в корзину",!0)}}async function re(n){try{const e=new FormData;e.append("productId",n),e.append("csrf_token",window.CSRF_TOKEN||"");const t=await fetch("/cart/remove",{method:"POST",body:e});if(!t.ok)throw new Error("Ошибка удаления из корзины");const a=await t.json();a.success?(l("Товар удален из корзины"),await E()):l(a.message||"Ошибка при удалении из корзины",!0)}catch{l("Ошибка при удалении из корзины",!0)}}async function le(){try{const n=new FormData;n.append("csrf_token",window.CSRF_TOKEN||"");const e=await fetch("/cart/clear",{method:"POST",body:n});if(!e.ok)throw new Error("Ошибка очистки корзины");const t=await e.json();t.success?(l("Корзина очищена"),await E()):l(t.message||"Ошибка при очистке корзины",!0)}catch{l("Ошибка при очистке корзины",!0)}}async function de(){const n=new FormData;n.append("csrf_token",window.CSRF_TOKEN);try{const t=await(await fetch("/specification/create",{method:"POST",body:n})).text();let a;try{a=JSON.parse(t)}catch{l("Ошибка сервера: неверный ответ. Попробуйте позже.",!0);return}a.success?(l("Спецификация создана"),window.cart={},E(),setTimeout(()=>{window.location.href=`/specification/${a.specification_id}`},1e3)):l(a.message||"Ошибка создания спецификации",!0)}catch{l("Ошибка соединения с сервером",!0)}}class ge{constructor(){this.searchInput=document.getElementById("searchInput"),this.autocompleteContainer=null,this.searchTimeout=null,this.autocompleteTimeout=null,this.selectedIndex=-1,this.lastQuery="",this.cache=new Map,this.init()}init(){this.searchInput&&(this.createAutocompleteContainer(),this.bindEvents())}createAutocompleteContainer(){this.autocompleteContainer=document.createElement("div"),this.autocompleteContainer.className="search-autocomplete",this.autocompleteContainer.style.cssText=`
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `,this.searchInput.parentElement.style.position="relative",this.searchInput.parentElement.appendChild(this.autocompleteContainer)}bindEvents(){this.searchInput.addEventListener("input",this.handleInput.bind(this)),this.searchInput.addEventListener("keydown",this.handleKeydown.bind(this)),this.searchInput.addEventListener("focus",this.handleFocus.bind(this)),this.searchInput.addEventListener("blur",()=>{setTimeout(()=>this.hideAutocomplete(),200)}),document.addEventListener("click",e=>{!this.searchInput.contains(e.target)&&!this.autocompleteContainer.contains(e.target)&&this.hideAutocomplete()})}handleInput(e){const t=e.target.value.trim();t?(window.appliedFilters.search=t,sessionStorage.setItem("search",t)):(delete window.appliedFilters.search,sessionStorage.removeItem("search")),clearTimeout(this.autocompleteTimeout),t.length>=2?this.autocompleteTimeout=setTimeout(()=>{this.fetchAutocomplete(t)},150):this.hideAutocomplete(),clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.performSearch()},300)}handleKeydown(e){const t=this.autocompleteContainer.querySelectorAll(".autocomplete-item");switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,t.length-1),this.highlightItem(t);break;case"ArrowUp":e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.highlightItem(t);break;case"Enter":e.preventDefault(),this.selectedIndex>=0&&t[this.selectedIndex]?this.selectAutocompleteItem(t[this.selectedIndex]):this.performSearch();break;case"Escape":this.hideAutocomplete();break}}handleFocus(){this.searchInput.value.length>=2&&this.fetchAutocomplete(this.searchInput.value)}highlightItem(e){e.forEach((t,a)=>{a===this.selectedIndex?(t.classList.add("highlighted"),t.scrollIntoView({block:"nearest"})):t.classList.remove("highlighted")})}async fetchAutocomplete(e){if(this.cache.has(e)){this.showAutocomplete(this.cache.get(e));return}try{const a=await(await fetch(`/search_autocomplete.php?q=${encodeURIComponent(e)}`)).json();if(this.cache.set(e,a.suggestions),this.cache.size>50){const i=this.cache.keys().next().value;this.cache.delete(i)}this.showAutocomplete(a.suggestions)}catch(t){console.error("Ошибка автодополнения:",t)}}showAutocomplete(e){if(!e||e.length===0){this.hideAutocomplete();return}this.autocompleteContainer.innerHTML="",this.selectedIndex=-1;const t=this.groupSuggestions(e);Object.entries(t).forEach(([a,i])=>{if(i.length===0)return;const s=document.createElement("div");s.className="autocomplete-header",s.style.cssText=`
                padding: 8px 12px;
                font-size: 12px;
                color: #666;
                background: #f5f5f5;
                font-weight: 600;
                border-bottom: 1px solid #eee;
            `,s.textContent=this.getGroupTitle(a),this.autocompleteContainer.appendChild(s),i.forEach(r=>{const o=document.createElement("div");o.className="autocomplete-item",o.style.cssText=`
                    padding: 10px 12px;
                    cursor: pointer;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    transition: background-color 0.2s;
                `,o.dataset.text=r.text;const c=document.createElement("span");c.innerHTML=this.highlightQuery(r.text,this.searchInput.value),o.appendChild(c);const d=document.createElement("span");d.style.cssText="font-size: 12px; color: #999;",d.textContent=this.getTypeIcon(a),o.appendChild(d),o.addEventListener("mouseenter",()=>{this.autocompleteContainer.querySelectorAll(".autocomplete-item").forEach(p=>{p.classList.remove("highlighted")}),o.classList.add("highlighted")}),o.addEventListener("click",()=>{this.selectAutocompleteItem(o)}),this.autocompleteContainer.appendChild(o)})}),this.autocompleteContainer.style.display="block"}groupSuggestions(e){const t={products:[],codes:[],brands:[],categories:[]};return e.forEach(a=>{switch(a.type||"product"){case"code":t.codes.push(a);break;case"brand":t.brands.push(a);break;case"category":t.categories.push(a);break;default:t.products.push(a)}}),t}getGroupTitle(e){return{products:"Товары",codes:"Артикулы",brands:"Бренды",categories:"Категории"}[e]||e}getTypeIcon(e){return{products:"📦",codes:"🔢",brands:"🏷️",categories:"📁"}[e]||""}highlightQuery(e,t){const a=new RegExp(`(${this.escapeRegex(t)})`,"gi");return e.replace(a,"<strong>$1</strong>")}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}selectAutocompleteItem(e){const t=e.dataset.text;this.searchInput.value=t,window.appliedFilters.search=t,sessionStorage.setItem("search",t),this.hideAutocomplete(),this.performSearch()}hideAutocomplete(){this.autocompleteContainer.style.display="none",this.selectedIndex=-1}async performSearch(){const e=this.searchInput.value.trim();if(e!==this.lastQuery){this.lastQuery=e,this.showSearchIndicator();try{if(await window.fetchProducts(),window.productsData.length===0&&e)this.suggestAlternatives(e);else{const t=document.querySelector(".search-suggestions");t&&t.remove()}}catch{l("Ошибка поиска",!0)}finally{this.hideSearchIndicator()}}}showSearchIndicator(){const e=this.searchInput.parentElement.querySelector(".search-indicator");e&&e.remove();const t=document.createElement("div");t.className="search-indicator",t.innerHTML='<div class="spinner-border spinner-border-sm"></div> Поиск...',t.style.cssText=`
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
        `,this.searchInput.parentElement.appendChild(t)}hideSearchIndicator(){const e=this.searchInput.parentElement.querySelector(".search-indicator");e&&e.remove()}async suggestAlternatives(e){var s;const t=document.createElement("div");t.className="search-suggestions",t.style.cssText=`
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        `,t.innerHTML=`
            <h5>Ничего не найдено по запросу "${e}"</h5>
            <p>Попробуйте:</p>
            <ul>
                <li>Проверить правильность написания</li>
                <li>Использовать более общие термины</li>
                <li>Искать по коду товара или бренду</li>
            </ul>
        `;const a=this.findAlternatives(e);if(a.length>0){const r=document.createElement("div");r.innerHTML="<p><strong>Возможно, вы искали:</strong></p>",a.forEach(o=>{const c=document.createElement("a");c.href="#",c.textContent=o,c.style.cssText="display: inline-block; margin: 0 10px 5px 0; color: #0066cc;",c.addEventListener("click",d=>{d.preventDefault(),this.searchInput.value=o,window.appliedFilters.search=o,this.performSearch()}),r.appendChild(c)}),t.appendChild(r)}const i=(s=document.querySelector(".product-table"))==null?void 0:s.parentElement;i&&i.insertBefore(t,i.firstChild)}findAlternatives(e){const t=[];e.length>5&&t.push(e.slice(0,-2));const a=e.split(/\s+/);a.length>1&&(t.push(a[0]),t.push(a[a.length-1]));const i=this.fixKeyboardLayout(e);return i!==e&&t.push(i),[...new Set(t)].slice(0,5)}fixKeyboardLayout(e){const t={й:"q",ц:"w",у:"e",к:"r",е:"t",н:"y",г:"u",ш:"i",щ:"o",з:"p",ф:"a",ы:"s",в:"d",а:"f",п:"g",р:"h",о:"j",л:"k",д:"l",я:"z",ч:"x",с:"c",м:"v",и:"b",т:"n",ь:"m"},a=Object.fromEntries(Object.entries(t).map(([r,o])=>[o,r])),s=/[а-яА-Я]/.test(e)?t:a;return e.split("").map(r=>s[r.toLowerCase()]||r).join("")}}new ge;window.itemsPerPage=parseInt(sessionStorage.getItem("itemsPerPage")||"20",10);window.currentPage=1;window.productsData=[];window.totalProducts=5e3;window.sortColumn=sessionStorage.getItem("sortColumn")||"name";window.sortDirection=sessionStorage.getItem("sortDirection")||"asc";window.appliedFilters={};window.cart={};window.searchTimeout=null;Object.keys(sessionStorage).forEach(n=>{["itemsPerPage","sortColumn","sortDirection"].includes(n)||(window.appliedFilters[n]=sessionStorage.getItem(n))});window.renderProductsTable=me;window.copyText=k;window.createSpecification=de;window.loadAvailability=H;window.addToCart=ce;window.clearCart=le;window.removeFromCart=re;window.fetchCart=E;window.filterByBrandOrSeries=z;const S=document.getElementById("citySelect");S&&(S.value=localStorage.getItem("selectedCityId")||"1",S.addEventListener("change",()=>{localStorage.setItem("selectedCityId",S.value),H(S.value)}));["itemsPerPageSelect","itemsPerPageSelectBottom"].forEach(n=>{const e=document.getElementById(n);e&&(e.value=window.itemsPerPage,e.addEventListener("change",fe))});["pageInput","pageInputBottom"].forEach(n=>{const e=document.getElementById(n);e&&(e.addEventListener("change",se),e.addEventListener("keydown",we))});const ie=document.getElementById("selectAll");ie&&ie.addEventListener("change",n=>{const e=n.target.checked;document.querySelectorAll(".product-checkbox").forEach(a=>{a.checked=e})});document.body.addEventListener("click",n=>{var t;const e=n.target;if(e.closest(".add-to-cart-btn")){const a=e.closest(".add-to-cart-btn"),i=a.dataset.productId,s=(t=a.closest("tr"))==null?void 0:t.querySelector(".quantity-input"),r=parseInt((s==null?void 0:s.value)||"1",10);ce(i,r);return}if(e.closest(".remove-from-cart-btn")){re(e.closest(".remove-from-cart-btn").dataset.productId);return}if(e.matches("#clearCartBtn")||e.closest(".clear-cart-btn")){le();return}if(e.closest(".create-specification-btn")){n.preventDefault(),de();return}});document.querySelectorAll(".prev-btn").forEach(n=>{n.addEventListener("click",e=>{e.preventDefault(),K(Math.max(1,window.currentPage-1))})});document.querySelectorAll(".next-btn").forEach(n=>{n.addEventListener("click",e=>{e.preventDefault();const t=Math.ceil(window.totalProducts/window.itemsPerPage);K(Math.min(t,window.currentPage+1))})});document.querySelector(".product-table")&&K(window.currentPage);document.querySelector(".cart-container")&&E().catch(console.error);
